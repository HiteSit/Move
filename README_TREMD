#!/bin/csh
#

# Generated by CHARMM-GUI (http://www.charmm-gui.org) v3.7
#
# This folder contains GROMACS formatted CHARMM36 force fields, a pre-optimized PDB structure, and GROMACS inputs.
# All input files were optimized for GROMACS 2019.2 or above, so lower version of GROMACS can cause some errors.
# We adopted the Verlet cut-off scheme for all minimization, equilibration, and production steps because it is 
# faster and more accurate than the group scheme. If you have a trouble with a performance of Verlet scheme while 
# running parallelized simulation, you should check if you are using appropriate command line.
# For MPI parallelizing, we recommand following command:
# mpirun -np $NUM_CPU gmx mdrun -ntomp 1

set init = step3_input
set mini_prefix = step4.0_minimization
set equi_prefix = step4.1_equilibration
set prod_prefix = step5_production
set prod_step   = step5
set num_rep = 64
set gmx_mpi = '/path/to/your/gmx_mpi'
set rep_ladder = ( 303.15 304.56 305.99 307.4 308.81 310.21 311.68 313.15 314.6 316.06 317.51 318.96 320.42 321.9 323.38 324.86 326.34 327.59 328.84 330.09 331.34 333.09 334.84 336.35 337.87 339.38 340.9 342.45 343.99 345.54 347.08 348.61 350.14 351.67 353.27 354.86 356.43 358.02 359.6 361.17 362.78 364.39 366 367.6 369.17 370.73 372.29 373.98 375.67 377.3 378.94 380.58 382.22 383.89 385.56 387.23 388.88 390.54 392.2 393.92 395.63 397.33 399.03 400 )


set dirs = `seq ${num_rep}`
set i = 1
while (${i} <= ${num_rep})
    mkdir ${i}
    sed "s/#temp/${rep_ladder[${i}]}/g" ${prod_prefix}.mdp > ${i}/${prod_prefix}.mdp
    @ i += 1
end

# Minimization
# In the case that there is a problem during minimization using a single precision of GROMACS, please try to use
# a double precision of GROMACS only for the minimization step.
gmx grompp -f ${mini_prefix}.mdp -o ${mini_prefix}.tpr -c ${init}.gro -r ${init}.gro -p topol.top -n index.ndx -maxwarn -1
gmx_d mdrun -v -deffnm ${mini_prefix}

# Equilibration
gmx grompp -f ${equi_prefix}.mdp -o ${equi_prefix}.tpr -c ${mini_prefix}.gro -r ${init}.gro -p topol.top -n index.ndx
gmx mdrun -v -deffnm ${equi_prefix}

# Production
set cnt    = 1
set cntmax = 10

while ( ${cnt} <= ${cntmax} )
    @ pcnt = ${cnt} - 1
    set istep = ${prod_step}_${cnt}
    set pstep = ${prod_step}_${pcnt}
    set i = 1
    if ( ${cnt} == 1 ) then
        set pstep = ${equi_prefix}
        while (${i} <= ${num_rep})
            gmx grompp -f ${i}/${prod_prefix}.mdp -o ${i}/${istep}.tpr -c ${pstep}.gro -p topol.top -n index.ndx
            @ i += 1
        end
    else
        while (${i} <= ${num_rep})
            gmx grompp -f ${i}/${prod_prefix}.mdp -o ${i}/${istep}.tpr -c ${i}/${pstep}.gro -t ${pstep}.cpt -p topol.top -n index.ndx
            @ i += 1
        end
    endif

    mpirun -np ${num_rep} ${gmx_mpi} mdrun -v -multidir ${dirs} -deffnm ${istep} -replex 100
    @ cnt += 1
end
